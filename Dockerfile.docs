# syntax=docker/dockerfile:1
FROM python:3.11-alpine

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    IN_DOCKER="1" \
    DOCUMENTATION="true" \
    DOCKER_MODE="docs" \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    TZ=Asia/Singapore \
    MAKEFLAGS="-j$(nproc)" \
    PYTHONHASHSEED=random \
    PIP_USE_PEP517=1 \
    PIP_PREFER_BINARY=1 \
    PIP_ONLY_BINARY=:all:

# Build arguments
ARG PARALLEL_JOBS=4
ARG VENV_PATH=/home/appuser/.nypai-chatbot/venv-docs

# Set environment variables from build args
ENV PIP_JOBS=${PARALLEL_JOBS} \
    VENV_PATH=${VENV_PATH}

WORKDIR /app

# Install system dependencies in a single layer
RUN apk add --no-cache \
    build-base \
    libffi-dev \
    openssl-dev \
    zlib-dev \
    curl \
    tzdata \
    ca-certificates \
    git \
    make \
    graphviz \
    && update-ca-certificates \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

# Create user and directories
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup -s /bin/sh && \
    mkdir -p /home/appuser/.nypai-chatbot/data/{cache,docs} && \
    mkdir -p /app/data && \
    mkdir -p /app/docs && \
    chown -R appuser:appgroup /app && \
    chown -R appuser:appgroup /home/appuser/.nypai-chatbot && \
    chmod -R 755 /home/appuser/.nypai-chatbot && \
    chmod -R 755 /app

# Switch to non-root user
USER appuser

# Create virtual environment
RUN python3 -m venv ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:$PATH" \
    PYTHONPATH=/app:/app/docs

# Copy documentation requirements first for better layer caching
COPY --chown=appuser:appgroup requirements-docs.txt ./

# Install Python dependencies for documentation
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    chmod +x $HOME/.local/bin/uv && \
    export PATH="$HOME/.local/bin:$PATH" && \
    ${VENV_PATH}/bin/pip install --upgrade pip wheel setuptools && \
    ${VENV_PATH}/bin/pip install uv && \
    export VIRTUAL_ENV=${VENV_PATH} && \
    uv pip install --upgrade pip wheel setuptools && \
    uv pip install --prerelease=allow -r requirements-docs.txt

# Copy application code
COPY --chown=appuser:appgroup app.py infra_utils.py performance_utils.py hashing.py flexcyon_theme.py system_prompts.py ./
COPY --chown=appuser:appgroup backend/ ./backend/
COPY --chown=appuser:appgroup gradio_modules/ ./gradio_modules/
COPY --chown=appuser:appgroup llm/ ./llm/
COPY --chown=appuser:appgroup styles/ ./styles/
COPY --chown=appuser:appgroup scripts/ ./scripts/
COPY --chown=appuser:appgroup infra_utils/ ./infra_utils/
COPY --chown=appuser:appgroup setup.py ./
COPY --chown=appuser:appgroup tests/ ./tests/
COPY --chown=appuser:appgroup misc/ ./misc/

# Copy the documentation generation script
COPY --chown=appuser:appgroup scripts/generate_docs.py ./

# Copy Sphinx configuration files
COPY --chown=appuser:appgroup docs/conf.py /app/docs/
COPY --chown=appuser:appgroup docs/index.rst /app/docs/
COPY --chown=appuser:appgroup docs/Makefile /app/docs/
COPY --chown=appuser:appgroup docs/extensions/ /app/docs/extensions/

# Copy existing RST files to preserve manual documentation
COPY --chown=appuser:appgroup docs/modules/ /app/docs/modules/

# Create Sphinx configuration directories
RUN mkdir -p /app/docs/_templates /app/docs/_static

# Make the script executable
RUN chmod +x /app/generate_docs.py

# Expose port for HTTP server
EXPOSE 8080

# Copy scripts/serve_docs.sh into the image and set it as the CMD. Make sure it is executable. Remove any previous CMD that ran the docs build or HTTP server directly.
COPY --chown=appuser:appgroup scripts/serve_docs.sh ./
RUN chmod +x /app/serve_docs.sh

# Set entrypoint and command
ENTRYPOINT ["/bin/sh", "-c"]
CMD ["/app/serve_docs.sh"]

# Print build information
RUN echo "[BUILD] Documentation Docker image built successfully" && \
    echo "[BUILD] Python executable: ${VENV_PATH}/bin/python" && \
    echo "[BUILD] Python version: $(${VENV_PATH}/bin/python --version)" && \
    echo "[BUILD] Sphinx version: $(${VENV_PATH}/bin/sphinx-build --version)"
