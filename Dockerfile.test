# syntax=docker/dockerfile:1

# Test Dockerfile for NYP FYP Chatbot
FROM python:3.11-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV IN_DOCKER="true"
ENV TESTING="true"

WORKDIR /app

# Install system dependencies including document processing tools
RUN apt-get update && apt-get install -y \
    build-essential \
    libffi-dev \
    libssl-dev \
    zlib1g-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libpng-dev \
    cmake \
    pkg-config \
    git \
    # Document processing dependencies
    pandoc \
    tesseract-ocr \
    tesseract-ocr-eng \
    poppler-utils \
    # Additional dependencies for better OCR and document processing
    libtesseract-dev \
    libpoppler-cpp-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies with optimizations
COPY requirements.txt ./
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy only the necessary application files
COPY app.py ./
COPY backend.py ./
COPY infra_utils.py ./
COPY performance_utils.py ./
COPY hashing.py ./
COPY flexcyon_theme.py ./

# Copy gradio modules
COPY gradio_modules/ ./gradio_modules/

# Copy LLM modules
COPY llm/ ./llm/

# Copy static assets
COPY styles/ ./styles/
COPY scripts/ ./scripts/

# Copy setup script for test execution
COPY setup.py ./

# Copy test files
COPY tests/ ./tests/

# Create necessary directories
RUN mkdir -p logs

# Set the default command to run dependency verification
CMD ["python", "tests/test_dependencies.py"]
