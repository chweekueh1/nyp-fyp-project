# ğŸ”§ Mermaid Syntax Validation and Search Result Highlighting Fixes

## Overview

This document describes the fixes implemented to address two key issues in the NYP FYP Chatbot:

1. **Mermaid Diagram Syntax Errors**: Prevents rendering errors when the LLM generates invalid Mermaid syntax
2. **Search Result Context Highlighting**: Improves search results by highlighting the specific parts that matched the query

## ğŸ¯ Issues Addressed

### 1. Mermaid Syntax Errors

**Problem**: When users ask the chatbot to create diagrams, the LLM sometimes generates invalid Mermaid syntax that causes Gradio's Markdown component to fail rendering, resulting in broken UI or error messages.

**Root Causes**:

- Missing Mermaid directives (e.g., `graph TD`, `sequenceDiagram`)
- Special characters in node names/labels that break HTML rendering
- Malformed diagram blocks
- Improper line endings

**Solution**: Implemented `validate_and_sanitize_mermaid_syntax()` function that:

- Detects Mermaid code blocks using regex
- Validates and fixes common syntax issues
- Sanitizes problematic characters
- Provides fallback diagrams for malformed content

### 2. Search Result Context

**Problem**: Search results showed the full message content but didn't highlight which parts matched the search query, making it difficult to understand why a result was returned.

**Solution**: Enhanced `format_search_results()` function with:

- Context-aware highlighting that shows surrounding text
- Bold highlighting of matched terms
- Truncation of long content with ellipsis
- Case-insensitive matching

## ğŸ”§ Technical Implementation

### Mermaid Syntax Validation

**Location**: `backend/chat.py`

**Function**: `validate_and_sanitize_mermaid_syntax(text: str) -> str`

**Features**:

```python
# Validates Mermaid directives
valid_directives = [
    'graph', 'flowchart', 'sequenceDiagram', 'classDiagram',
    'gantt', 'pie', 'mindmap', 'erDiagram', 'journey', 'gitgraph'
]

# Sanitizes HTML entities
sanitized_content = re.sub(r'[<>"&]', lambda m: {
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    '&': '&amp;'
}.get(m.group(0), m.group(0)), mermaid_content)
```

**Integration**: Automatically called in `get_chatbot_response()` before saving to chat history

### Search Result Highlighting

**Location**: `backend/chat.py`

**Function**: `highlight_query_in_text(text: str, query: str) -> str`

**Features**:

```python
# Case-insensitive matching
text_lower = text.lower()
query_lower = query.lower()

# Context-aware highlighting with truncation
if len(context_before) > 50:
    context_before = "..." + context_before[-47:]

# Bold highlighting of matches
highlighted_parts.append(f"**{text[start:end]}**")
```

**Integration**: Used in both `format_search_results()` functions (with and without similarity scores)

## ğŸ“‹ Test Coverage

**Test File**: `tests/backend/test_mermaid_and_search_fixes.py`

**Test Cases**:

### Mermaid Validation Tests

1. âœ… Valid Mermaid diagram (should pass through unchanged)
2. âœ… Missing directive (should add `flowchart TD`)
3. âœ… Invalid characters (should escape HTML entities)
4. âœ… Empty diagram (should show error message)
5. âœ… No Mermaid blocks (should be unchanged)

### Search Highlighting Tests

1. âœ… Highlight "data" in content
2. âœ… Highlight "security" in content
3. âœ… Highlight "classification" in content
4. âœ… No highlights for non-existent terms

### Complete Search Tests

1. âœ… Search for "data" (multiple matches)
2. âœ… Search for "security" (bot responses)
3. âœ… Search for "classification" (bot responses)
4. âœ… Search for "levels" (bot response)
5. âœ… Search for "nonexistent" (no results)

## ğŸš€ Usage Examples

### Mermaid Validation

**Before** (problematic):

```mermaid
A[<script>alert('xss')</script>] --> B[End]
```

**After** (sanitized):

```mermaid
flowchart TD
    A[&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;] --> B[End]
```

### Search Highlighting

**Before**:

```
Content: Hello, I need help with data security classifications.
```

**After**:

```
Content: Hello, I need help with **data** **security** **classification**s.
```

## ğŸ”„ Integration Points

### Chat Response Processing

```python
# In get_chatbot_response()
answer_text = result.get("answer", "No answer generated by AI.")
answer_text = validate_and_sanitize_mermaid_syntax(answer_text)  # NEW
```

### Search Results Display

```python
# In format_search_results()
highlighted_content = highlight_query_in_text(content, query)  # NEW
```

## ğŸ“Š Performance Impact

- **Mermaid Validation**: Minimal impact - only processes text containing Mermaid blocks
- **Search Highlighting**: Minimal impact - simple string operations
- **Memory Usage**: No significant increase
- **Response Time**: Negligible additional processing time

## ğŸ›¡ï¸ Error Handling

### Mermaid Validation

- Graceful fallback for malformed diagrams
- Logs warnings for debugging
- Never crashes the application
- Provides user-friendly error diagrams

### Search Highlighting

- Handles empty/null inputs gracefully
- Case-insensitive matching
- Preserves original text if highlighting fails
- No exceptions thrown

## ğŸ”® Future Enhancements

### Potential Improvements

1. **Advanced Mermaid Validation**: More sophisticated syntax checking
2. **Custom Highlighting Styles**: Different highlight colors for different match types
3. **Fuzzy Highlighting**: Highlight similar terms, not just exact matches
4. **Search Result Snippets**: Show more context around matches
5. **Interactive Diagrams**: Clickable Mermaid diagrams

### Monitoring

- Add metrics for Mermaid validation success/failure rates
- Track search highlighting usage patterns
- Monitor performance impact over time

## âœ… Verification

To verify the fixes are working:

1. **Run the test suite**:

   ```bash
   python tests/backend/test_mermaid_and_search_fixes.py
   ```

2. **Test Mermaid diagrams**:
   - Ask the chatbot to create a flowchart
   - Verify it renders correctly in the UI
   - Check that invalid syntax is handled gracefully

3. **Test search highlighting**:
   - Search for terms in chat history
   - Verify matched terms are highlighted in bold
   - Check that context is shown around matches

## ğŸ“ Conclusion

These fixes significantly improve the user experience by:

- Preventing Mermaid diagram rendering errors
- Making search results more informative and easier to understand
- Maintaining system stability and performance
- Providing graceful error handling

The implementation is robust, well-tested, and maintains backward compatibility with existing functionality.
